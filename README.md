# üè• Meu Hospital: Documenta√ß√£o de Arquitetura de Microsservi√ßos


# ‚öôÔ∏è Como Iniciar o Projeto (Setup Guide)

Este projeto utiliza o **Docker Compose** para orquestrar todos os microsservi√ßos e suas depend√™ncias (PostgreSQL, Kafka, MongoDB, MailHog) em um √∫nico comando.

## Pr√©-requisitos

Para rodar o projeto, voc√™ deve ter instalados:

1.  **Docker** e **Docker Compose** (Obrigat√≥rio para iniciar a infraestrutura).
2.  **Java 21** e **Maven 3.8+** (Necess√°rio para compilar o c√≥digo antes do Docker).

-----

##  Configura√ß√£o de Credenciais (`.env` File)

O projeto requer que voc√™ crie um arquivo de ambiente (`.env`) na **raiz do seu mono-repo** para injetar credenciais e URLs. Este arquivo protege dados sens√≠veis e √© ignorado pelo Git.

1.  Crie um arquivo chamado **`.env`** na raiz do projeto.
2.  Preencha-o com as vari√°veis abaixo. **Mantenha os valores das chaves secretas longos e seguros\!**

```bash
# ==========================================================
# CONFIGURA√á√ïES DE INFRAESTRUTURA E CREDENCIAIS
# ==========================================================

# 1. CREDENCIAIS GERAIS DO BANCO DE DADOS (Postgres e Mongo)
DB_USERNAME=user
DB_PASSWORD=password

# 2. NOMES DOS BANCOS DE DADOS
AUTENTICACAO_DB_NAME=autenticacao_db
AGENDAMENTO_DB_NAME=agendamento_db
HISTORICO_DB_NAME=historico_db
MONGODB_DB=notificacao_db

# 3. SEGURAN√áA (JWT)
# As chaves secretas s√£o injetadas diretamente nos microsservi√ßos.
JWT_SECRET="chave-secreta-muito-longa-e-segura-para-assinatura-jwt-meuhospital-2025-a1b2c3d4e5f6g7h8"
JWT_EXPIRATION_MS=3600000 # 1 hora
INTERNAL_SECRET="segredo-interno-muito-seguro-para-comunicacao-entre-microservicos-2025"

# 4. CONFIGURA√á√ïES MONGODB (Para Inje√ß√£o de Credenciais)
MONGODB_USER=user
MONGODB_PASSWORD=password

# 5. CONFIGURA√á√ÉO DE HOSTS E PORTAS (Uso local/opcional)
# ATEN√á√ÉO: Os microsservi√ßos usam 'kafka:9092' internamente. Estes s√£o para acesso externo/UI.
DB_HOST=localhost
DB_PORT=5432
KAFKA_HOST=localhost
KAFKA_PORT_EXTERNAL=9093 # Porta externa para acesso ao Kafka (ex: Kafka UI)
MAILHOG_PORT_SMTP=1025 # Porta SMTP para envio de emails
```

-----

## Inicializa√ß√£o do Projeto

Siga os passos de compila√ß√£o e orquestra√ß√£o para colocar a arquitetura no ar:

### Passo A: Compila√ß√£o dos JARs

Execute o Maven para compilar o c√≥digo Java, gerar o m√≥dulo de contratos e empacotar cada microsservi√ßo:

```bash
mvn clean install -DskipTests
```

### Passo B: Subir a Infraestrutura (Docker Compose)

O Docker Compose ir√° criar redes virtuais, provisionar os bancos de dados, o Kafka e, em seguida, construir as imagens dos microsservi√ßos a partir dos JARs gerados.

```bash
docker-compose up --build -d
```

O flag `-d` executa tudo em *background*. Use `docker-compose logs -f` para monitorar a inicializa√ß√£o.

-----

## Acesso e Observabilidade

Ap√≥s a inicializa√ß√£o completa, acesse as ferramentas de observabilidade e os *endpoints* da aplica√ß√£o:

| Servi√ßo | Fun√ß√£o | Porta Padr√£o | URL de Acesso |
| :--- | :--- | :--- | :--- |
| **MS Autentica√ß√£o (REST)** | Login e Cadastro | `8080` | `http://localhost:8080` |
| **MS Agendamento (REST)** | Cria√ß√£o/Gest√£o de Consultas | `8081` | `http://localhost:8081` |
| **MS Hist√≥rico (GraphQL)** | Consultas de Leitura | `8084` | `http://localhost:8084/graphiql` |
| **MailHog (UI de E-mail)** | Caixa de Entrada Virtual | `8025` | `http://localhost:8025` |
| **Kafka UI** | Monitoramento de T√≥picos e Mensagens | `8085` | `http://localhost:8085` |

**Pr√≥xima etapa:** Use a **Cole√ß√£o do Postman** importada para executar os fluxos de trabalho (`Login`, `Agendamento`, `Cancelamento`) e verificar as notifica√ß√µes no MailHog.

## üéØ I. Arquitetura

Este projeto implementa o backend do **Meu Hospital** como uma arquitetura de microsservi√ßos em um **Mono-repo Multi-m√≥dulo**. O design √© focado na resili√™ncia e no desacoplamento, utilizando os padr√µes:

* **CQRS (Command Query Responsibility Segregation) Light:** Separa√ß√£o da l√≥gica de escrita (Comando) e leitura (Query) em servi√ßos e modelos de dados dedicados.
* **Comunica√ß√£o Event-Driven:** Utiliza√ß√£o de eventos ass√≠ncronos via **Kafka** para garantir o baixo acoplamento entre os dom√≠nios de **Autentica√ß√£o**, **Agendamento**, **Notifica√ß√£o** e **Hist√≥rico**.

### 1.1. Decis√£o Estrat√©gica: Mono-repo Maven

A escolha por um reposit√≥rio √∫nico com m√∫ltiplos m√≥dulos Maven foi uma decis√£o arquitetural crucial para a **sa√∫de** e **rastreabilidade** do projeto:

| Vantagem | Detalhe |
| :--- | :--- |
| **Versionamento Unificado** | O **POM Pai** centraliza as vers√µes de todos os *frameworks* e depend√™ncias (Spring Boot, Kafka, JJWT), garantindo a compatibilidade em todo o ecossistema. |
| **Refatora√ß√£o At√¥mica** | Mudan√ßas cr√≠ticas no m√≥dulo de Contratos s√£o **imediatamente validadas** em todos os servi√ßos no momento do *build*, eliminando falhas de depend√™ncia em tempo de execu√ß√£o (Princ√≠pio *Fail-Fast*). |

### 1.2. M√≥dulo de Contratos (`meuhospital-contracts`)

Este m√≥dulo √© a espinha dorsal do **desacoplamento**. Ele cont√©m **exclusivamente** o m√≠nimo necess√°rio para a comunica√ß√£o, isolando a regra de neg√≥cio dos vizinhos:

* **DTOs:** (Ex: `LoginRequest`, `ConsultaRequest`, `UsuarioResponse`).
* **Enums:** (Ex: `Role`).
* **Eventos Kafka:** (Ex: `MedicoEvent`, `ConsultaCriadaEvent`).

-----

## ‚Ö°. Stack Tecnol√≥gico e Containers

O ambiente de desenvolvimento (DevOps) √© totalmente orquestrado via **Docker Compose**, utilizando vari√°veis de ambiente injetadas pelo arquivo `.env` (padr√£o profissional de seguran√ßa).

### 2.1. Tecnologias Core

| Camada | Tecnologia | Implementa√ß√£o Espec√≠fica |
| :--- | :--- | :--- |
| **Linguagem & Framework** | Java 21, Spring Boot 3.5.x | Uso de *Records* (DTOs) e Inje√ß√£o por Construtor (DDD). |
| **Mensageria** | Apache Kafka / Zookeeper | Assincronicidade para notifica√ß√£o e padr√µes CQRS/Saga. |
| **Persist√™ncia Relacional** | PostgreSQL (JPA) | Utilizado por `ms-autenticacao`, `ms-agendamento`, `ms-historico` (isolados por dom√≠nio). |
| **Persist√™ncia NoSQL** | MongoDB | **Auditoria de logs** e rastreamento (ms-notificacao). |
| **Client S√≠ncrono** | WebClient | Comunica√ß√£o *Service-to-Service* **n√£o-bloqueante** (reativa). |
| **Documenta√ß√£o** | Springdoc OpenAPI (Swagger) | Documenta√ß√£o REST (8080/8081) e GraphQL. |

### 2.2. Containers e Monitoramento (Observabilidade)

A infraestrutura de suporte ao desenvolvimento e observabilidade.

| Container | Fun√ß√£o | Porta Exp. | Credencial de Acesso |
| :--- | :--- | :--- | :--- |
| `ms-autenticacao` | Identity Service, Produtor Kafka | 8080 | - |
| `ms-agendamento` | Business Logic, Orquestrador | 8081 | - |
| `ms-historico` | Read-Model, API GraphQL | 8084 | - |
| **`mailhog`** | Servidor SMTP Falso | **8025** | Acesso Livre via Web UI |
| **`mongodb`** | Log de Auditoria | 27017 | `user` / `password (admin)` |
| **`mongo-express`** | UI de Auditoria MongoDB | **8083** | `user_express` / `password_express` |
| **`kafka-ui`** | Monitoramento Kafka | **8085** | Acesso Livre via Web UI |

-----

## III. Fluxos Cr√≠ticos e Detalhe da Comunica√ß√£o

O sistema opera com fluxos transacionais que exigem diferentes mecanismos de comunica√ß√£o (S√≠ncrono RPC vs. Ass√≠ncrono Event-Driven).

### 3.1. Fluxo 1: Sincroniza√ß√£o de M√©dicos (CQRS/Read-Model)

O objetivo √© evitar que o `ms-agendamento` precise fazer chamadas s√≠ncronas para o `ms-autenticacao` para buscar dados de m√©dicos, usando o padr√£o CQRS para ter uma **proje√ß√£o de dados locais**.

| Servi√ßo | A√ß√£o | Mecanismo | Detalhe |
| :--- | :--- | :--- | :--- |
| `ms-autenticacao` | Publica o cadastro de m√©dico. | **Kafka Produtor** (`MedicoProducer`) | Envia o `MedicoEvent` (ID, nome, CRM, especialidade). |
| `ms-agendamento` | Consome e Armazena. | **Kafka Consumidor** (`MedicoConsumer`) | Salva/Atualiza a **`MedicoProjection`** local em seu DB PostgreSQL. |

### 3.2. Fluxo 2: Cria√ß√£o de Consulta (Transacional H√≠brida)

O fluxo de escrita exige valida√ß√£o externa (S√≠ncrona) e, em seguida, disparo de notifica√ß√£o (Ass√≠ncrono).

| Servi√ßo | A√ß√£o | Mecanismo | Detalhe |
| :--- | :--- | :--- | :--- |
| `ms-agendamento` | Valida√ß√£o de Exist√™ncia do Paciente. | **RPC S√≠ncrono (WebClient)** | Chamada `GET /usuarios/{id}` para `ms-autenticacao` para buscar o nome/contato e confirmar a exist√™ncia. |
| `ms-agendamento` | Valida√ß√£o de Regras. | **L√≥gica de Dom√≠nio** | Verifica a disponibilidade na tabela local (`MedicoProjection` e `Consulta`). |
| `ms-agendamento` | Disparo de Notifica√ß√£o. | **Kafka Produtor** (`ConsultaProducer`) | Publica `ConsultaCriadaEvent` no t√≥pico `notificacao-events`. |

### 3.3. Fluxo 3: Cancelamento e Jobs Agendados

#### Cancelamento de Consulta (`DELETE` L√≥gico)

1.  O `ms-agendamento` recebe o comando `DELETE /consultas/{id}` (requer **M√âDICO/ENFERMEIRO**).
2.  O `ConsultaService` faz uma chamada **s√≠ncrona** ao `ms-autenticacao` para recuperar o E-mail e Telefone do paciente.
3.  O status da entidade `Consulta` √© alterado para **CANCELADA** no DB.
4.  O servi√ßo publica um evento **CANCELAMENTO** no Kafka.

#### Disparo de Lembrete (`@Scheduled`)

* **Job:** O `ms-agendamento` executa um Job (`@Scheduled`) diariamente √†s **18:00** (Job Lembrete).
* **A√ß√£o:** O Job busca consultas agendadas para o dia seguinte e publica um evento de tipo **LEMBRETE** no Kafka, acionando o `ms-notificacao`.

-----

## I‚Ö§. Seguran√ßa e Autoriza√ß√£o (Regras)

### 4.1. Mecanismo JWT (`SecurityFilter`)

O filtro de seguran√ßa est√° replicado em `ms-autenticacao`, `ms-agendamento` e `ms-historico`.

* **Fun√ß√£o:** Valida o JWT recebido, extrai as *claims* (`id`, `role`) e injeta no **`SecurityContext`**.
* **Decis√£o de Filtro:** A inje√ß√£o dos filtros (`addFilterBefore(..., UsernamePasswordAuthenticationFilter.class)`) garante que a autentica√ß√£o JWT ocorra **antes** de qualquer verifica√ß√£o de formul√°rio padr√£o.

### 4.2. Chave Secreta (*Firewall Service-to-Service*)

Para proteger rotas internas cr√≠ticas, como a busca de dados de usu√°rio por ID:

1.  O `ms-agendamento` envia o *header* **`X-Internal-Secret`** (lido do `.env`) em requisi√ß√µes para `ms-autenticacao`.
2.  O `ms-autenticacao` utiliza o **`InternalServiceFilter`** para verificar essa chave.
3.  Se a chave for v√°lida, o acesso √© permitido na rota `GET /usuarios/{id}`; caso contr√°rio, a requisi√ß√£o √© bloqueada com **`401 Unauthorized`**.

-----

## V. Entreg√°veis e Estrutura de Arquivos

### 5.1. Documenta√ß√£o Swagger (OpenAPI JSON)

A documenta√ß√£o da API √© gerada automaticamente pelo **Springdoc** e √© o principal entreg√°vel para a comunica√ß√£o de *endpoints*.

| Servi√ßo | URL de Teste Swagger/GraphQL |
| :--- | :--- |
| `ms-autenticacao` | `http://localhost:8080/swagger-ui.html` |
| `ms-agendamento` | `http://localhost:8081/swagger-ui.html` |

![Swagger Autenticacao](docs/images/swagger-auth.png)
http://localhost:8080/swagger-ui/index.html |
URL OpenAPI JSON:  http://localhost:8080/v3/api-docs
-----

![Swagger Agendamento](docs/images/swagger-agendamento.png)
http://localhost:8081/swagger-ui/index.html |
URL OpenAPI JSON:  http://localhost:8081/v3/api-docs
-----

### 5.2. Estrutura de Pastas (Hierarquia Completa)

#### Estrutura do Projeto Global (Mono-repo Multi-m√≥dulo)

```bash
meu-hospital-mono-repo/
‚îú‚îÄ‚îÄ meuhospital-contracts/ ¬† ¬† # M√≥dulo de Contratos (DTOs, Enums, Eventos Kafka)
‚îÇ¬† ¬†‚îî‚îÄ‚îÄ pom.xml ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†# Depend√™ncia crucial para todos os microsservi√ßos
‚îú‚îÄ‚îÄ ms-autenticacao/ ¬† ¬† ¬† ¬† ¬† # Identity Service (Autentica√ß√£o JWT)
‚îú‚îÄ‚îÄ ms-agendamento/ ¬† ¬† ¬† ¬† ¬† ¬†# Business Logic e Orquestra√ß√£o
‚îú‚îÄ‚îÄ ms-historico/ ¬† ¬† ¬† ¬† ¬† ¬† ¬†# Read-Model e API GraphQL
‚îú‚îÄ‚îÄ ms-notificacao/ ¬† ¬† ¬† ¬† ¬† ¬†# Event Listener e Auditoria
‚îî‚îÄ‚îÄ pom.xml ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†# POM Pai (Gerencia vers√µes e depend√™ncias globais)
```

#### `ms-autenticacao` (Identity Service)

Gerencia usu√°rios, roles (perfis) e a emiss√£o de tokens JWT.

```bash
ms-autenticacao/
‚îú‚îÄ‚îÄ src/main/java/com/postechfiap/meuhospital/autenticacao/
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ controller/ ¬† ¬† ¬† ¬† # UsuarioController, AuthController (REST APIs de Login/Cadastro)
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ service/impl/ ¬† ¬† ¬† # UsuarioServiceImpl (L√≥gica de Neg√≥cio, Criptografia de Senha)
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ repository/ ¬† ¬† ¬† ¬† # Interfaces JPA (PostgreSQL para dados de usu√°rio)
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ security/ ¬† ¬† ¬† ¬† ¬† # Filtros JWT, Handlers 401/403, InternalServiceFilter
‚îÇ¬† ¬†‚îî‚îÄ‚îÄ kafka/ ¬† ¬† ¬† ¬† ¬† ¬† ¬†# MedicoProducer (Publica eventos de cadastro/atualiza√ß√£o de M√©dico)
‚îú‚îÄ‚îÄ src/main/resources/ ¬† ¬† ¬†# application.yaml, arquivos de credencial
‚îî‚îÄ‚îÄ pom.xml
```

#### `ms-agendamento` (Orquestrador de Consultas)

Gerencia o agendamento, atualiza√ß√£o e cancelamento de consultas m√©dicas.

```bash
ms-agendamento/
‚îú‚îÄ‚îÄ src/main/java/com/postechfiap/meuhospital/agendamento/
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ controller/ ¬† ¬† ¬† ¬† # ConsultaController (Endpoints REST: POST/PUT/DELETE)
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ service/impl/ ¬† ¬† ¬† # ConsultaService (L√≥gica Transacional, Valida√ß√µes H√≠bridas)
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ repository/ ¬† ¬† ¬† ¬† # Interfaces JPA (PostgreSQL para Consultas)
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ projection/ ¬† ¬† ¬† ¬† # MedicoProjection (CQRS Read Model, consumido do Kafka)
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ kafka/ ¬† ¬† ¬† ¬† ¬† ¬† ¬†# ConsultaProducer (Publica eventos CRIACAO, CANCELAMENTO, LEMBRETE)
‚îÇ¬† ¬†‚îî‚îÄ‚îÄ scheduler/ ¬† ¬† ¬† ¬† ¬†# JobLembrete (@Scheduled - Disparo di√°rio de lembretes)
‚îú‚îÄ‚îÄ src/main/resources/ ¬† ¬† ¬†# application.yaml, .env
‚îî‚îÄ‚îÄ pom.xml
```

#### `ms-notificacao` (Consumidor de Eventos e Simulador de E-mail)

Respons√°vel por consumir eventos Kafka e simular o envio de e-mails.

```bash
ms-notificacao/
‚îú‚îÄ‚îÄ src/main/java/com/postechfiap.meuhospital.notificacao/
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ kafka/ ¬† ¬† ¬† ¬† ¬† ¬† ¬†# NotificacaoConsumer (Consome eventos do t√≥pico notificacao-events)
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ service/impl/ ¬† ¬† ¬† # EmailService (Integra√ß√£o com MailHog/SMTP)
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ repository/ ¬† ¬† ¬† ¬† # Interfaces para persist√™ncia MongoDB (Auditoria/Logs)
‚îÇ¬† ¬†‚îî‚îÄ‚îÄ model/ ¬† ¬† ¬† ¬† ¬† ¬† ¬†# Documentos MongoDB (Ex: LogAuditoria)
‚îú‚îÄ‚îÄ src/main/resources/ ¬† ¬† ¬†# application.yaml, configura√ß√£o do MongoDB
‚îî‚îÄ‚îÄ pom.xml
```

#### `ms-historico` (Read-Model via GraphQL)

Fornece uma API GraphQL para consultas hist√≥ricas de agendamentos.

```bash
ms-historico/
‚îú‚îÄ‚îÄ src/main/java/com/postechfiap.meuhospital.historico/
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ graphql/ ¬† ¬† ¬† ¬† ¬† ¬†# Controller/DataFetcher para queries/mutations GraphQL
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ service/impl/ ¬† ¬† ¬† # HistoricoService (L√≥gica de Consulta/Filtro)
‚îÇ¬† ¬†‚îú‚îÄ‚îÄ repository/ ¬† ¬† ¬† ¬† # Interfaces JPA (PostgreSQL dedicado para Hist√≥rico)
‚îÇ¬† ¬†‚îî‚îÄ‚îÄ kafka/ ¬† ¬† ¬† ¬† ¬† ¬† ¬†# ConsultaConsumer (Consome eventos de CRIACAO/CANCELAMENTO para alimentar a base)
‚îú‚îÄ‚îÄ src/main/resources/ ¬† ¬† ¬†# application.yaml
‚îî‚îÄ‚îÄ pom.xml
```

### 5.3. Detalhe do Fluxo de E-mail (MailHog)

A simula√ß√£o de e-mail √© rastre√°vel e vis√≠vel na interface do **MailHog (Porta 8025)**, sendo acionada pelo `ms-notificacao` ao consumir eventos Kafka.

| Tipo de Evento | Rota de Disparo (ms-agendamento) | E-mail Enviado |
| :--- | :--- | :--- |
| **CRIACAO** | `POST /consultas` | Confirma√ß√£o de agendamento. |
| **ATUALIZACAO** | `PUT /consultas/{id}` | Alerta de altera√ß√£o de hor√°rio. |
| **CANCELAMENTO** | `DELETE /consultas/{id}` | Notifica√ß√£o de cancelamento. |
| **LEMBRETE** | Job `@Scheduled` | Lembrete de consulta para o dia seguinte. |

-----

## VI. Observabilidade e Auditoria (Visuais Essenciais)

### 6.1. Fluxos de Mensageria (Kafka-UI - Porta 8085)
![Captura de tela do Kafka-UI com T√≥picos Ativos](docs/images/kafka-ui.png)
* **Imagem 1: T√≥picos Ativos no Kafka-UI**
    * **Descri√ß√£o:** Lista de t√≥picos (`notificacao-events`, `medico-events`) com contagem de mensagens, confirmando que os produtores est√£o funcionando e os dados est√£o sendo armazenados.
      Acesse: http://localhost:8085/ui/clusters/meu-hospital-cluster/all-topics

### 6.2. Comunica√ß√£o Ass√≠ncrona (MailHog - Porta 8025)
![Mailhog](docs/images/mailhog.png)
* **Imagem 2: Caixa de Entrada do MailHog com M√∫ltiplos E-mails**
    * **Descri√ß√£o:** UI do MailHog com e-mails de diferentes tipos: `Confirma√ß√£o de Agendamento` (Cria√ß√£o), `Alerta de Altera√ß√£o` (Atualiza√ß√£o), `Notifica√ß√£o de Cancelamento` e `Lembrete de Consulta`. Isso prova que o `ms-notificacao` consome todos os eventos de forma correta.
    Acesse: http://localhost:8025/#]

![Mailhog](docs/images/email-agendamento.png)
* **Imagem 3: Detalhe de um E-mail de Confirma√ß√£o**
    * **Descri√ß√£o:** Mostrar o corpo de um e-mail espec√≠fico (ex: Confirma√ß√£o de Agendamento) para validar que o servi√ßo de notifica√ß√£o utiliza os dados do evento corretamente.

### 6.3. Logs e Provas de Auditoria (Mongo-Express - Porta 8083)
![Mongoexpress](docs/images/mongoexpress.png)
* **Imagem 4: Visualiza√ß√£o de Logs no Mongo-Express**
    * **Descri√ß√£o:** Interface do Mongo-Express exibindo o conte√∫do de um documento na cole√ß√£o de `LogAuditoria` (mantida pelo `ms-notificacao`), comprovando que o MongoDB est√° ativo e registrando as opera√ß√µes de eventos (por exemplo, "Evento de Cria√ß√£o de Consulta consumido e processado").
Acesse: http://localhost:8083/db/notificacao_db/logs_notificacao

-----
